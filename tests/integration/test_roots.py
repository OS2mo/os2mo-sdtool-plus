# SPDX-FileCopyrightText: Magenta ApS <https://magenta.dk>
# SPDX-License-Identifier: MPL-2.0
from uuid import UUID

import pytest
from httpx import AsyncClient
from more_itertools import last
from more_itertools import one
from respx import MockRouter

from sdtoolplus.autogenerated_graphql_client import GraphQLClient
from sdtoolplus.config import SDToolPlusSettings
from sdtoolplus.depends import SDClient
from sdtoolplus.mo.timeline import _mo_end_to_timeline_end
from sdtoolplus.mo_org_unit_importer import OrgUnitLevelUUID
from sdtoolplus.mo_org_unit_importer import OrgUnitUUID
from sdtoolplus.models import POSITIVE_INFINITY
from sdtoolplus.roots import ensure_sd_institution_units


@pytest.mark.integration_test
async def test_roots(
    test_client: AsyncClient,
    graphql_client: GraphQLClient,
    org_unit_type: OrgUnitUUID,
    org_unit_levels: dict[str, OrgUnitLevelUUID],
    sdtoolplus_settings: SDToolPlusSettings,
    respx_mock: MockRouter,
):
    """
    We are testing the function to ensure the SD institutions are present in the
    top of the OU-tree. The following subtree paths for root are considered:

    SD institution: AA
    Subtree path: 12121212-1212-1212-1212-121212121212/aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa
    (this institution MO unit is already present in MO, and the UUID of the SD
    institution is the same as the UUID of the MO unit)

    SD institution: BB
    Subtree path: 12121212-1212-1212-1212-121212121212/20000000-0000-0000-0000-000000000000
    (this institution MO unit is already present in MO, but the UUID of the SD
    institution is NOT the same as the UUID of the MO unit)

    SD institution CC
    Subtree path: 12121212-1212-1212-1212-121212121212/cccccccc-cccc-cccc-cccc-cccccccccccc
    (this institution MO unit is not already found in MO)
    """
    # Arrange
    root_uuid = UUID("12121212-1212-1212-1212-121212121212")
    AA_uuid = UUID("aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa")
    BB_uuid = UUID("bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb")
    CC_uuid = UUID("cccccccc-cccc-cccc-cccc-cccccccccccc")

    settings_ = sdtoolplus_settings.dict()
    settings_.update(
        {
            "mo_subtree_paths_for_root": {
                "AA": [root_uuid, AA_uuid],
                "BB": [root_uuid, BB_uuid],
                "CC": [root_uuid, CC_uuid],
            },
            "sd_region_identifier": "RI",
        }
    )
    settings = SDToolPlusSettings.parse_obj(settings_)

    # Build the base tree structure
    await graphql_client._testing__create_org_unit(
        uuid=root_uuid,
        name="Root",
        user_key="root",
        org_unit_type=org_unit_type,
        from_date=settings.min_mo_datetime,
    )

    await graphql_client._testing__create_org_unit(
        uuid=AA_uuid,
        name="Institution AA",
        user_key="AA",
        org_unit_type=org_unit_type,
        org_unit_level=org_unit_levels["TOP"],
        from_date=settings.min_mo_datetime,
        parent=root_uuid,
    )

    await graphql_client._testing__create_org_unit(
        # Note - we are using this UUID instead of the AA_uuid
        uuid=UUID("20000000-0000-0000-0000-000000000000"),
        name="Institution BB",
        user_key="BB",
        org_unit_type=org_unit_type,
        org_unit_level=org_unit_levels["TOP"],
        from_date=settings.min_mo_datetime,
        parent=root_uuid,
    )

    def get_inst_sd_resp(institution_identifier: str) -> str:
        assert settings.mo_subtree_paths_for_root is not None

        institution_uuid_identifier = str(
            last(settings.mo_subtree_paths_for_root[institution_identifier])
        )

        return f"""<?xml version="1.0" encoding="UTF-8"?>
            <GetInstitution20111201 creationDateTime="2025-09-22T14:18:59">
              <RequestStructure>
                <RegionIdentifier>RI</RegionIdentifier>
                <InstitutionIdentifier>II</InstitutionIdentifier>
                <AdministrationIndicator>false</AdministrationIndicator>
                <ContactInformationIndicator>false</ContactInformationIndicator>
                <PostalAddressIndicator>false</PostalAddressIndicator>
                <ProductionUnitIndicator>false</ProductionUnitIndicator>
                <UUIDIndicator>true</UUIDIndicator>
              </RequestStructure>
              <Region>
                <RegionIdentifier>RI</RegionIdentifier>
                <RegionUUIDIdentifier>aba6cd29-2a01-4da6-9542-e0040da418e1</RegionUUIDIdentifier>
                <RegionName>Magenta</RegionName>
                <Institution>
                  <InstitutionIdentifier>{institution_identifier}</InstitutionIdentifier>
                  <InstitutionUUIDIdentifier>{institution_uuid_identifier}</InstitutionUUIDIdentifier>
                  <InstitutionName>Institution {institution_identifier}</InstitutionName>
                </Institution>
              </Region>
            </GetInstitution20111201>
        """

    respx_mock.get(
        "https://service.sd.dk/sdws/GetInstitution20111201?RegionIdentifier=RI&InstitutionIdentifier=AA&AdministrationIndicator=False&ContactInformationIndicator=False&PostalAddressIndicator=False&ProductionUnitIndicator=False&UUIDIndicator=True"
    ).respond(
        content_type="text/xml;charset=UTF-8",
        content=get_inst_sd_resp("AA"),
    )

    respx_mock.get(
        "https://service.sd.dk/sdws/GetInstitution20111201?RegionIdentifier=RI&InstitutionIdentifier=BB&AdministrationIndicator=False&ContactInformationIndicator=False&PostalAddressIndicator=False&ProductionUnitIndicator=False&UUIDIndicator=True"
    ).respond(
        content_type="text/xml;charset=UTF-8",
        content=get_inst_sd_resp("BB"),
    )

    respx_mock.get(
        "https://service.sd.dk/sdws/GetInstitution20111201?RegionIdentifier=RI&InstitutionIdentifier=CC&AdministrationIndicator=False&ContactInformationIndicator=False&PostalAddressIndicator=False&ProductionUnitIndicator=False&UUIDIndicator=True"
    ).respond(
        content_type="text/xml;charset=UTF-8",
        content=get_inst_sd_resp("CC"),
    )

    mock_context = {"graphql_client": graphql_client}

    # Act
    async with ensure_sd_institution_units(
        settings=settings,
        sd_client=SDClient("username", "password"),
        context=mock_context,  # type: ignore
    ):
        pass

    # Assert
    AA_unit = await graphql_client.get_org_unit_timeline(AA_uuid, None, None)
    validity = one(one(AA_unit.objects).validities)

    assert validity.validity.from_ == settings.min_mo_datetime
    assert _mo_end_to_timeline_end(validity.validity.to) == POSITIVE_INFINITY
    assert validity.name == "Institution AA"
    assert validity.user_key == "AA"
    assert validity.org_unit_level is not None
    assert validity.org_unit_level.name == "TOP"
    assert validity.parent_uuid == root_uuid

    BB_unit = await graphql_client.get_org_unit_timeline(
        UUID("20000000-0000-0000-0000-000000000000"), None, None
    )
    validity = one(one(BB_unit.objects).validities)

    assert validity.validity.from_ == settings.min_mo_datetime
    assert _mo_end_to_timeline_end(validity.validity.to) == POSITIVE_INFINITY
    assert validity.name == "Institution BB"
    assert validity.user_key == "BB"
    assert validity.org_unit_level is not None
    assert validity.org_unit_level.name == "TOP"
    assert validity.parent_uuid == root_uuid

    CC_unit = await graphql_client.get_org_unit_timeline(CC_uuid, None, None)
    validity = one(one(CC_unit.objects).validities)

    assert validity.validity.from_ == settings.min_mo_datetime
    assert _mo_end_to_timeline_end(validity.validity.to) == POSITIVE_INFINITY
    assert validity.name == "Institution CC"
    assert validity.user_key == "CC"
    assert validity.org_unit_level is not None
    assert validity.org_unit_level.name == "TOP"
    assert validity.parent_uuid == root_uuid
